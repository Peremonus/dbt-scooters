/**
 * АНАЛИЗ ПЛОТНОСТИ ЗАВЕРШЕНИЯ ПОЕЗДОК С ИСПОЛЬЗОВАНИЕМ ГЕКСАГОНАЛЬНОЙ СЕТКИ
 * 
 * Этот запрос создает гексагональную сетку с мелкими ячейками (10 метров)
 * и подсчитывает количество поездок, завершающихся в каждой ячейке.
 * Используется для точного анализа точечной плотности завершения поездок.
 */

SELECT
    -- Преобразуем геометрию гексагона обратно в WGS84 (широта/долгота)
    -- 4326 = стандартная SRID для GPS координат, совместимая с большинством GIS-инструментов
    ST_Transform(hex.geom, 4326) AS geom,
    
    -- Подсчитываем количество поездок, завершающихся в каждой гексагональной ячейке
    COUNT(*) AS trips_count

FROM
    -- Используем dbt-референс для получения таблицы с геометрией поездок
    -- trips_geom должна содержать finish_point (геометрия точки завершения поездки)
    {{ ref("trips_geom") }} AS t

-- CROSS JOIN создает декартово произведение между всеми поездками и гексагональной сеткой
-- Это необходимо для сопоставления каждой точки завершения с соответствующей ячейкой сетки
CROSS JOIN
    ST_HexagonGrid(
        -- Очень мелкий размер ячейки - 10 метров
        -- Подходит для анализа точечной плотности на небольшой территории
        -- (например, анализ стоянок, парковок, точечных скоплений)
        10,
        
        -- Преобразуем точки завершения поездок в Web Mercator (3857)
        -- Web Mercator использует метры как единицы измерения, что позволяет
        -- корректно работать с расстояниями в метрах при создании сетки
        ST_Transform(
            t.finish_point,  -- Геометрия точки завершения поездки
            3857  -- SRID для Web Mercator Projection (единицы измерения - метры)
        )
    ) AS hex  -- Псевдоним для гексагональной сетки

WHERE
    -- Фильтруем только те пары точка-гексагон, где точка завершения попадает в ячейку
    ST_Intersects(
        -- Точка завершения поездки в Web Mercator для корректного spatial join
        ST_Transform(
            t.finish_point, 
            3857
        ),
        
        -- Геометрия гексагона (автоматически создается в SRID 3857)
        hex.geom
    )

-- Группируем результаты по геометрии гексагона
-- Это позволяет агрегировать подсчет поездок для каждой уникальной ячейки
GROUP BY
    hex.geom  -- Группировка по геометрии ячейки