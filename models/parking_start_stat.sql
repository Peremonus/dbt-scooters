/**
 * АНАЛИЗ ПЛОТНОСТИ ПОЕЗДОК С ИСПОЛЬЗОВАНИЕМ ГЕКСАГОНАЛЬНОЙ СЕТКИ
 * 
 * Этот запрос создает гексагональную сетку и подсчитывает количество поездок,
 * начинающихся в каждой ячейке сетки. Используется для пространственного анализа
 * плотности и распределения поездок.
 */

SELECT
    -- Преобразуем геометрию гексагона обратно в WGS84 (широта/долгота)
    -- для совместимости с большинством GIS-инструментов и карт
    ST_Transform(hex.geom, 4326) AS geom,
    
    -- Подсчитываем количество поездок в каждой гексагональной ячейке
    COUNT(*) AS trips_count

FROM
    -- Используем dbt-референс для получения таблицы с геометрией поездок
    -- Это обеспечивает зависимость между моделями в dbt-проекте
    {{ ref("trips_geom") }} AS trips

-- CROSS JOIN создает декартово произведение между поездками и гексагональной сеткой
-- Это необходимо для сопоставления каждой точки с соответствующей ячейкой сетки
CROSS JOIN
    ST_HexagonGrid(
        -- Размер стороны гексагона в метрах (500 м = оптимально для городского анализа)
        500,
        
        -- Преобразуем точки начала поездок в Web Mercator (3857)
        -- Web Mercator использует метры как единицы измерения, что позволяет
        -- корректно работать с расстояниями в метрах при создании сетки
        ST_Transform(
            trips.start_point, 
            3857  -- SRID для Web Mercator Projection
        )
    ) AS hex  -- Псевдоним для гексагональной сетки

WHERE
    -- Фильтруем только те пары точка-гексагон, где точка попадает в ячейку
    ST_Intersects(
        -- Точка начала поездки в Web Mercator для корректного spatial join
        ST_Transform(
            trips.start_point, 
            3857
        ),
        
        -- Геометрия гексагона (автоматически создается в той же SRID, что и входные данные)
        hex.geom
    )

-- Группируем результаты по геометрии гексагона
-- Это позволяет агрегировать подсчет поездок для каждой уникальной ячейки
GROUP BY
    hex.geom  -- Группировка по геометрии ячейки (более явно, чем GROUP BY 1)